<div id="vikunja-dashboard" style="
    background: #121212; 
    color: #fff; 
    font-family: 'Inter', sans-serif; 
    padding: 20px;
    border-radius: 16px;
    border: 1px solid #333;
    width: 320px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);">

  <div style="display: flex; 
      justify-content: space-between; 
      margin-bottom: 20px;">
    <div style="display: flex; align-items: center; gap: 8px;">
      <span style="font-size: 1.5em;">📌</span>
      <span style="font-weight: 700;">TASK CENTER</span>
    </div>
    <span id="task-count" style="
        background: #4db8ff; color: #000; 
        padding: 2px 10px; border-radius: 20px; 
        font-size: 0.8em; font-weight: bold;">0</span>
  </div>

  <div id="task-list" style="
      display: flex; flex-direction: column; 
      gap: 12px; max-height: 400px;
      overflow-y: auto;">
    <div style="text-align: center; color: #666;">
      資料同步中... 🔄
    </div>
  </div>
</div>

<script>
(async () => {
  const url = 'https://todo.yichlin.com/api/v1/tasks/all';
  const token = 'tk_e4a6e6cb708078e7030e2fccab83ae88e06cadd3';
  const params = new URLSearchParams({
    'filter': 'due_date <= now/d+1d && done = false',
    'filter_timezone': 'Asia/Taipei'
  });

  // 優先度對應設定
  const prioMap = {
    1: { icon: '⚪', label: 'Low', color: '#888' },
    2: { icon: '🔵', label: 'Medium', color: '#4db8ff' },
    3: { icon: '🟡', label: 'High', color: '#ffcc00' },
    4: { icon: '🟠', label: 'Urgent', color: '#ff9900' },
    5: { icon: '🔴', label: 'DO NOW', color: '#ff4d4d' }
  };

  try {
    const response = await fetch(`${url}?${params}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const tasks = await response.json();
    const listEl = document.getElementById('task-list');
    const countEl = document.getElementById('task-count');
    listEl.innerHTML = '';

    const now = new Date();
    const todayTasks = (tasks || []).filter(t => {
      if (!t.due_date || t.due_date.startsWith('0001')) return false;
      return new Date(t.due_date).toDateString() === now.toDateString();
    });

    countEl.innerText = todayTasks.length;

    if (todayTasks.length === 0) {
      listEl.innerHTML = '<div style="text-align:center; color:#444;">🐾 暫無任務</div>';
      return;
    }

    todayTasks.forEach(t => {
      const due = new Date(t.due_date);
      const time = due.toLocaleTimeString([], 
        {hour: '2-digit', minute:'2-digit', hour12: false});
      
      // 取得優先度資訊，預設為 1
      const p = prioMap[t.priority] || prioMap[1];
      
      const card = document.createElement('div');
      card.style.cssText = `
        background: #1e1e1e; padding: 12px;
        border-radius: 12px; border-left: 4px solid ${p.color};
        display: flex; justify-content: space-between;
        align-items: center; transition: 0.2s;
      `;
      
      card.innerHTML = `
        <div style="overflow: hidden;">
          <div style="font-size: 0.9em; color: #eee;
              white-space: nowrap; overflow: hidden;
              text-overflow: ellipsis;">
            ${p.icon} ${t.title}
          </div>
          <div style="font-size: 0.7em; color: #555; margin-top: 4px;">
            Priority: ${p.label}
          </div>
        </div>
        <div style="font-size: 0.8em; color: ${p.color}; font-weight: bold;">
          ${time}
        </div>
      `;
      listEl.appendChild(card);
    });

  } catch (err) {
    document.getElementById('task-list').innerHTML = 
      '<div style="color:#ff4d4d; font-size:0.8em;">❌ API 連線錯誤</div>';
  }
})();
</script>