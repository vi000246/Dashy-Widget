<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<style>
  body, html {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    background: transparent;
    overflow: hidden; /* éš±è—å¤–éƒ¨æ²è»¸ */
  }
  #vikunja-dashboard {
    background: #121212; /* æˆ–è¨­ç‚º transparent */
    color: #fff;
    font-family: 'Inter', sans-serif;
    /* ç§»é™¤å¯¬åº¦é™åˆ¶èˆ‡åœ“è§’é™°å½± */
    width: 300px; height: 100vh;
    padding: 12px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 12px;
  }
  .task-list {
    flex: 1; /* è‡ªå‹•å¡«æ»¿å‰©é¤˜é«˜åº¦ */
    display: flex;
    flex-direction: column;
    gap: 8px;
    overflow-y: auto;
    padding-right: 4px;
  }
  /* è‡ªå®šç¾©æ²è»¸æ¨£å¼ */
  .task-list::-webkit-scrollbar { width: 4px; }
  .task-list::-webkit-scrollbar-thumb {
    background: #444; border-radius: 4px;
  }
</style>


</head>
<body>

<div id="vikunja-dashboard">
  <div class="header">
    <div style="display: flex; align-items: center; gap: 8px;">
      <span style="font-size: 1.2em;">ğŸˆâ€â¬›</span>
      <span style="font-weight: 700; font-size: 0.9em;">
        TASK CENTER
      </span>
    </div>
    <span id="task-count" style="
        background: #4db8ff; color: #000;
        padding: 2px 8px; border-radius: 12px;
        font-size: 0.75em; font-weight: bold;">0</span>
  </div>

  <div id="task-list" class="task-list">
    </div>
</div>

<script>
(async () => {
  const listEl = document.getElementById('task-list');
  const countEl = document.getElementById('task-count');
  
  const url = 'https://todo.yichlin.com/api/v1/tasks/all';
  const token = 'tk_e4a6e6cb708078e7030e2fccab83ae88e06cadd3';
  const params = new URLSearchParams({
    'filter': 'due_date <= now/d+1d && done = false',
    'filter_timezone': 'Asia/Taipei'
  });

  const prioMap = {
    1: { icon: 'âšª', label: 'Low', color: '#888' },
    2: { icon: 'ğŸ”µ', label: 'Medium', color: '#4db8ff' },
    3: { icon: 'ğŸŸ¡', label: 'High', color: '#ffcc00' },
    4: { icon: 'ğŸŸ ', label: 'Urgent', color: '#ff9900' },
    5: { icon: 'ğŸ”´', label: 'DO NOW', color: '#ff4d4d' }
  };

  try {
    const res = await fetch(`${url}?${params}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    
    const tasks = await res.json();
    listEl.innerHTML = '';
    
    const now = new Date();
    // å–å¾—ä»Šæ—¥ä»»å‹™
    const todayTasks = (tasks || []).filter(t => {
      if (!t.due_date || t.due_date.startsWith('0001')) 
        return false;
      return new Date(t.due_date).toDateString() === 
             now.toDateString();
    });

    countEl.innerText = todayTasks.length;

    if (todayTasks.length === 0) {
      listEl.innerHTML = '<div style="text-align:center; padding:20px;">ğŸ¾ ä»Šæ—¥ç„¡ä»»å‹™</div>';
      return;
    }

    todayTasks.forEach(t => {
      const due = new Date(t.due_date);
      const time = due.toLocaleTimeString([], 
        {hour: '2-digit', minute:'2-digit', hour12: false});
      const p = prioMap[t.priority] || prioMap[1];
      
      const card = document.createElement('div');
      card.style.cssText = `
        background: #1e1e1e; padding: 12px;
        border-radius: 12px; border-left: 4px solid ${p.color};
        display: flex; justify-content: space-between;
        align-items: center;
      `;
      
      card.innerHTML = `
        <div style="overflow: hidden; flex: 1;">
          <div style="font-size: 0.85em; color: #eee;
              white-space: nowrap; overflow: hidden;
              text-overflow: ellipsis;">
            ${p.icon} ${t.title}
          </div>
          <div style="font-size: 0.65em; color: #555; margin-top: 4px;">
            Priority: ${p.label}
          </div>
        </div>
        <div style="font-size: 0.8em; color: ${p.color}; 
            font-weight: bold;">
          ${time}
        </div>
      `;
      listEl.appendChild(card);
    });
  } catch (err) {
    listEl.innerHTML = `<div style="color:#ff4d4d; font-size:0.7em;">âŒ éŒ¯èª¤: ${err.message}</div>`;
  }
})();
</script>
</body>
</html>
