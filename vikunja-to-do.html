<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<style>
  body, html {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    background: transparent; overflow: hidden;
  }
  #vikunja-dashboard {
    background: #121212; color: #fff;
    font-family: 'Inter', sans-serif;
    width: 100%; height: 100vh;
    padding: 12px; box-sizing: border-box;
    display: flex; flex-direction: column;
  }
  .task-list {
    flex: 1; display: flex;
    flex-direction: column; gap: 8px;
    overflow-y: auto; padding-top: 8px;
  }
</style>
</head>
<body>

<div id="vikunja-dashboard">
  <div style="display: flex; justify-content: space-between;">
    <div style="display: flex; align-items: center; gap: 8px;">
      <span>ğŸˆâ€â¬›</span>
      <span style="font-weight: 700; font-size: 0.9em;">TASK CENTER</span>
    </div>
    <span id="task-count" style="background: #4db8ff; 
      color: #000; padding: 2px 8px; border-radius: 12px; 
      font-size: 0.75em; font-weight: bold;">0</span>
  </div>

  <div id="task-list" class="task-list">
    <div id="status-msg" style="text-align: center; color: #666; font-size: 0.8em; padding: 20px;">
      è³‡æ–™åŒæ­¥ä¸­... ğŸ”„
    </div>
  </div>
</div>

<script>
async function initDashboard() {
  const listEl = document.getElementById('task-list');
  const countEl = document.getElementById('task-count');
  
  const url = 'https://todo.yichlin.com/api/v1/tasks/all';
  const token = 'tk_e4a6e6cb708078e7030e2fccab83ae88e06cadd3';
  const params = new URLSearchParams({
    'filter': 'due_date <= now/d+1d && done = false',
    'filter_timezone': 'Asia/Taipei'
  });

  const prioMap = {
    1: { icon: 'âšª', color: '#888' },
    2: { icon: 'ğŸ”µ', color: '#4db8ff' },
    3: { icon: 'ğŸŸ¡', color: '#ffcc00' },
    4: { icon: 'ğŸŸ ', color: '#ff9900' },
    5: { icon: 'ğŸ”´', color: '#ff4d4d' }
  };

  try {
    const res = await fetch(`${url}?${params}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    
    const tasks = await res.json();
    if (!Array.isArray(tasks)) throw new Error("API æ ¼å¼éŒ¯èª¤");

    const now = new Date();
    const todayTasks = tasks.filter(t => {
      if (!t.due_date || t.due_date.startsWith('0001')) return false;
      return new Date(t.due_date).toDateString() === now.toDateString();
    });

    // å®‰å…¨è¨­å®šæ•¸å­—ï¼Œé˜²æ­¢ null éŒ¯èª¤
    if (countEl) countEl.innerText = todayTasks.length;
    listEl.innerHTML = '';

    if (todayTasks.length === 0) {
      listEl.innerHTML = '<div style="text-align:center;color:#444;padding:20px;">ğŸ¾ ä»Šæ—¥æš«ç„¡ä»»å‹™</div>';
      return;
    }

    todayTasks.forEach(t => {
      const due = new Date(t.due_date);
      const time = due.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
      const p = prioMap[t.priority] || prioMap[1];
      
      const card = document.createElement('div');
      card.style.cssText = `background:#1e1e1e; padding:10px; border-radius:10px; border-left:4px solid ${p.color}; display:flex; justify-content:space-between; align-items:center;`;
      card.innerHTML = `
        <div style="overflow:hidden; flex:1; margin-right:8px;">
          <div style="font-size:0.85em; color:#eee; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${p.icon} ${t.title}</div>
        </div>
        <div style="font-size:0.8em; color:${p.color}; font-weight:bold;">${time}</div>
      `;
      listEl.appendChild(card);
    });
  } catch (err) {
    if (listEl) listEl.innerHTML = `<div style="color:#ff4d4d; font-size:0.7em; padding:10px;">âŒ ${err.message}</div>`;
  }
}

// ç¢ºä¿ç¶²é è¼‰å…¥å¾Œæ‰åŸ·è¡Œ JS
window.onload = initDashboard;
</script>
</body>
</html>
